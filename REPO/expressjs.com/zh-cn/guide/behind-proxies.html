<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn" xml:lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>代理背后的 Express</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
  </head>
  <body>
    <header id="title-block-header">
      <h1 class="title">代理背后的 Express</h1>
    </header>
    <h1 id="代理背后的-express">代理背后的 Express</h1>
    <p>
      在代理背后运行 Express 应用程序时，可使用
      <a href="/%7B%7B%20page.lang%20%7D%7D/4x/api.html#app.set">app.set()</a>
      将应用程序变量 <code>trust proxy</code> 设置为下表中所列的某个值。
    </p>
    <div class="doc-box doc-info" data-markdown="1">
      <p>
        尽管不设置应用程序变量
        <code>trust proxy</code> 该应用程序也不会运行失败，但是它会误将代理的 IP
        地址注册为客户机 IP 地址（除非配置了 <code>trust proxy</code>）。
      </p>
    </div>
    <table class="doctable" border="1" markdown="1">
      <thead>
        <tr>
          <th>类型</th>
          <th>值</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>布尔</td>
          <td>
            如果为 <code>true</code>，那么客户机的 IP 地址将用作
            <code>X-Forwarded-*</code> 头中最左侧的条目。 如果为
            <code>false</code>，那么该应用程序将被视为直接面对因特网，而客户机的
            IP 地址则派生自
            <code>req.connection.remoteAddress</code>。这是缺省设置。
          </td>
        </tr>
        <tr>
          <td>IP 地址</td>
          <td>
            <p>
              要信任的 IP 地址、子网或者一组 IP
              地址与子网。以下列表显示预先配置的子网名称： * loopback -
              <code>127.0.0.1/8</code> 或 <code>::1/128</code> * linklocal -
              <code>169.254.0.0/16</code> 或 <code>fe80::/10</code> *
              uniquelocal -
              <code>10.0.0.0/8</code>、<code>172.16.0.0/12</code>、<code
                >192.168.0.0/16</code
              >
              或 <code>fc00::/7</code>
            </p>
            <p>您可以按以下某种方法设置 IP 地址：</p>
            <pre>
<code class="language-js" translate="no">app.set('trust proxy', 'loopback') // specify a single subnet
app.set('trust proxy', 'loopback, 123.123.123.123') // specify a subnet and an address
app.set('trust proxy', 'loopback, linklocal, uniquelocal') // specify multiple subnets as CSV
app.set('trust proxy', ['loopback', 'linklocal', 'uniquelocal']) // specify multiple subnets as an array</code>
</pre>
            如果指定 IP
            地址或子网，那么会在地址确定过程中排除这些项，而将最接近应用程序服务器的不受信任的
            IP 地址确定为客户机的 IP 地址。
          </td>
        </tr>
        <tr>
          <td>数字</td>
          <td>
            信任来自正面代理服务器的第 <code>n</code> 个中继段，以此作为客户机。
          </td>
        </tr>
        <tr>
          <td>函数</td>
          <td>
            定制信任实现。仅当您知道自己要做什么时，方可使用该选项。
            <pre>
<code class="language-js" translate="no">app.set('trust proxy', function (ip) {
  if (ip === '127.0.0.1' || ip === '123.123.123.123') return true; // trusted IPs
  else return false;
});</code>
</pre>
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      设置非 <code>false</code> <code>trust proxy</code> 值会导致三个重大变化：
    </p>
    <ul>
      <li>
        <a href="/%7B%7B%20page.lang%20%7D%7D/api.html#req.hostname"
          >req.hostname</a
        >
        的值派生自
        <code>X-Forwarded-Host</code>
        头中设置的值（可以由客户机或代理设置此值）。
      </li>
      <li>
        <code>X-Forwarded-Proto</code> 可以由逆向代理设置，以告知应用程序：它是
        <code>https</code> 还是 <code>http</code>，或者甚至是无效名称。该值由
        <a href="/%7B%7B%20page.lang%20%7D%7D/api.html#req.protocol"
          >req.protocol</a
        >
        反映。
      </li>
      <li>
        <a href="/%7B%7B%20page.lang%20%7D%7D/api.html#req.ip">req.ip</a> 和
        <a href="/%7B%7B%20page.lang%20%7D%7D/api.html#req.ips">req.ips</a> 值由
        <code>X-Forwarded-For</code> 的地址列表填充。
      </li>
    </ul>
    <p>
      <code>trust proxy</code> 设置由使用
      <a href="https://www.npmjs.com/package/proxy-addr">proxy-addr</a>
      包实现。有关更多信息，请参阅其文档。
    </p>
  </body>
</html>
