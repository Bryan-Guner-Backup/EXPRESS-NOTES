<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko" xml:lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>상태 검사와 우아한 종료</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
    <style type="text/css">
      a.sourceLine {
        display: inline-block;
        line-height: 1.25;
      }
      a.sourceLine {
        pointer-events: none;
        color: inherit;
        text-decoration: inherit;
      }
      a.sourceLine:empty {
        height: 1.2em;
      }
      .sourceCode {
        overflow: visible;
      }
      code.sourceCode {
        white-space: pre;
        position: relative;
      }
      div.sourceCode {
        margin: 1em 0;
      }
      pre.sourceCode {
        margin: 0;
      }
      @media screen {
        div.sourceCode {
          overflow: auto;
        }
      }
      @media print {
        code.sourceCode {
          white-space: pre-wrap;
        }
        a.sourceLine {
          text-indent: -1em;
          padding-left: 1em;
        }
      }
      pre.numberSource a.sourceLine {
        position: relative;
        left: -4em;
      }
      pre.numberSource a.sourceLine::before {
        content: attr(title);
        position: relative;
        left: -1em;
        text-align: right;
        vertical-align: baseline;
        border: none;
        pointer-events: all;
        display: inline-block;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        padding: 0 4px;
        width: 4em;
        color: #aaaaaa;
      }
      pre.numberSource {
        margin-left: 3em;
        border-left: 1px solid #aaaaaa;
        padding-left: 4px;
      }
      div.sourceCode {
      }
      @media screen {
        a.sourceLine::before {
          text-decoration: underline;
        }
      }
      code span.al {
        color: #ff0000;
        font-weight: bold;
      } /* Alert */
      code span.an {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Annotation */
      code span.at {
        color: #7d9029;
      } /* Attribute */
      code span.bn {
        color: #40a070;
      } /* BaseN */
      code span.bu {
      } /* BuiltIn */
      code span.cf {
        color: #007020;
        font-weight: bold;
      } /* ControlFlow */
      code span.ch {
        color: #4070a0;
      } /* Char */
      code span.cn {
        color: #880000;
      } /* Constant */
      code span.co {
        color: #60a0b0;
        font-style: italic;
      } /* Comment */
      code span.cv {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* CommentVar */
      code span.do {
        color: #ba2121;
        font-style: italic;
      } /* Documentation */
      code span.dt {
        color: #902000;
      } /* DataType */
      code span.dv {
        color: #40a070;
      } /* DecVal */
      code span.er {
        color: #ff0000;
        font-weight: bold;
      } /* Error */
      code span.ex {
      } /* Extension */
      code span.fl {
        color: #40a070;
      } /* Float */
      code span.fu {
        color: #06287e;
      } /* Function */
      code span.im {
      } /* Import */
      code span.in {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Information */
      code span.kw {
        color: #007020;
        font-weight: bold;
      } /* Keyword */
      code span.op {
        color: #666666;
      } /* Operator */
      code span.ot {
        color: #007020;
      } /* Other */
      code span.pp {
        color: #bc7a00;
      } /* Preprocessor */
      code span.sc {
        color: #4070a0;
      } /* SpecialChar */
      code span.ss {
        color: #bb6688;
      } /* SpecialString */
      code span.st {
        color: #4070a0;
      } /* String */
      code span.va {
        color: #19177c;
      } /* Variable */
      code span.vs {
        color: #4070a0;
      } /* VerbatimString */
      code span.wa {
        color: #60a0b0;
        font-weight: bold;
        font-style: italic;
      } /* Warning */
    </style>
  </head>
  <body>
    <header id="title-block-header">
      <h1 class="title">상태 검사와 우아한 종료</h1>
    </header>
    <h1 id="상태-확인와-정상-종료">상태 확인와 정상 종료</h1>
    <h2 id="정상-종료">정상 종료</h2>
    <p>
      애플리케이션의 새 버전을 배포할 때, 이전 버전을 교체해야 합니다. 여러분이
      사용하는 <a href="pm.html">프로세스 매니저</a>는 애플리케어션에 SIGTERM
      신호를 보내 종료를 통보할 것입니다. 애플리케이션이 신호를 받으면, 신규
      요청을 받는걸 중단하고, 진행중인 요청을 끝내고, DB 연결이나 파일 사용을
      포함한 사용한 리소스를 정리할 것입니다.
    </p>
    <h2 id="상태-확인">상태 확인</h2>
    <p>
      A load balancer uses health checks to determine if an application instance
      is healthy and can accept requests. For example,
      <a
        href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/"
        >Kubernetes has two health checks</a
      >: 로드 밸런서는 상태 확인을 애플리케이션이 장상 작동하고 요청을 받을 수
      있는지 판단하는데 사용합니다. 예시로,
      <a
        href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/"
        >Kubernetes는 2개의 상태 확인을 가지고 있습니다.</a
      >
    </p>
    <ul>
      <li><code>liveness</code>: 언제 컨테이너를 재시작할지 결정합니다.</li>
      <li>
        <code>readiness</code>: 컨테이너가 트래픽을 받기 시작할 준비가 되었는지
        결정합니다. 컨테이너가 준비되지 않았다면, 서비스 로드 밸런서들에게서
        제거됩니다.
      </li>
    </ul>
    <h2 id="서드-파티-솔루션">서드 파티 솔루션</h2>
    <p>{% include community-caveat.html %}</p>
    <h3 id="terminus">Terminus</h3>
    <p>
      <a href="https://github.com/godaddy/terminus">Terminus</a>는 상용구 코드를
      쓸 필요를 제거하기 위해 상태 확인 절차와 정상 종료를 추가하는 오픈소스
      프로젝트입니다. 먼저 정상 종료를 위한 자원 청소 로직과 상태 확인 로직만
      제공하면 됩니다. 그러면 Terminus가 나머지를 처리할겁니다.
    </p>
    <p>아래 명령을 사용해 Terminus를 설치합니다.</p>
    <div class="sourceCode" id="cb1">
      <pre
        class="sourceCode sh"
      ><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1"><span class="ex">npm</span> i @godaddy/terminus --save</a></code></pre>
    </div>
    <p>
      다음은 Terminus를 사용하는 쉬운 예제입니다. 자세한 정보는
      <a href="https://github.com/godaddy/terminus" class="uri"
        >https://github.com/godaddy/terminus</a
      >
      를 참고하세요.
    </p>
    <div class="sourceCode" id="cb2">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">const</span> http <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;http&#39;</span>)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">const</span> terminus <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;@godaddy/terminus&#39;</span>)</a>
<a class="sourceLine" id="cb2-4" title="4"></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()</a>
<a class="sourceLine" id="cb2-6" title="6"></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-8" title="8">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;ok&#39;</span>)</a>
<a class="sourceLine" id="cb2-9" title="9"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb2-10" title="10"></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="kw">const</span> server <span class="op">=</span> <span class="va">http</span>.<span class="at">createServer</span>(app)</a>
<a class="sourceLine" id="cb2-12" title="12"></a>
<a class="sourceLine" id="cb2-13" title="13"><span class="kw">function</span> <span class="at">onSignal</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb2-14" title="14">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;server is starting cleanup&#39;</span>)</a>
<a class="sourceLine" id="cb2-15" title="15">  <span class="co">// start cleanup of resource, like databases or file descriptors</span></a>
<a class="sourceLine" id="cb2-16" title="16"><span class="op">}</span></a>
<a class="sourceLine" id="cb2-17" title="17"></a>
<a class="sourceLine" id="cb2-18" title="18"><span class="kw">async</span> <span class="kw">function</span> <span class="at">onHealthCheck</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb2-19" title="19">  <span class="co">// checks if the system is healthy, like the db connection is live</span></a>
<a class="sourceLine" id="cb2-20" title="20">  <span class="co">// resolves, if health, rejects if not</span></a>
<a class="sourceLine" id="cb2-21" title="21"><span class="op">}</span></a>
<a class="sourceLine" id="cb2-22" title="22"></a>
<a class="sourceLine" id="cb2-23" title="23"><span class="at">terminus</span>(server<span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-24" title="24">  <span class="dt">signal</span><span class="op">:</span> <span class="st">&#39;SIGINT&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb2-25" title="25">  <span class="dt">healthChecks</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-26" title="26">    <span class="st">&#39;/healthcheck&#39;</span><span class="op">:</span> onHealthCheck</a>
<a class="sourceLine" id="cb2-27" title="27">  <span class="op">},</span></a>
<a class="sourceLine" id="cb2-28" title="28">  onSignal</a>
<a class="sourceLine" id="cb2-29" title="29"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb2-30" title="30"></a>
<a class="sourceLine" id="cb2-31" title="31"><span class="va">server</span>.<span class="at">listen</span>(<span class="dv">3000</span>)</a></code></pre>
    </div>
    <h3 id="lightship">Lightship</h3>
    <p>
      <a href="https://github.com/gajus/lightship">Lightship</a>은
      애플리케이션에 상태, 준비, 생존 확인을 추가하는 오픈소스 프로젝트입니다.
      Lightship은 스탠드얼론 HTTP 서비스로 분리된 HTTP 서비스를 구동합니다. 이를
      통해 확인 절차들을 공개적으로 노출시키지 않고 할 수 있게 해줍니다.
    </p>
    <p>아래 명령을 사용해 Lightship을 설치합니다.</p>
    <div class="sourceCode" id="cb3">
      <pre
        class="sourceCode sh"
      ><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1"><span class="ex">npm</span> install lightship</a></code></pre>
    </div>
    <p>Lightship을 사용하는 쉬운 예제입니다.</p>
    <div class="sourceCode" id="cb4">
      <pre
        class="sourceCode js"
      ><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">const</span> http <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;http&#39;</span>)</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">const</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-4" title="4">  createLightship</a>
<a class="sourceLine" id="cb4-5" title="5"><span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;lightship&#39;</span>)</a>
<a class="sourceLine" id="cb4-6" title="6"></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co">// Lightship will start a HTTP service on port 9000.</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="kw">const</span> lightship <span class="op">=</span> <span class="at">createLightship</span>()</a>
<a class="sourceLine" id="cb4-9" title="9"></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()</a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-13" title="13">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;ok&#39;</span>)</a>
<a class="sourceLine" id="cb4-14" title="14"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb4-15" title="15"></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="va">app</span>.<span class="at">listen</span>(<span class="dv">3000</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-17" title="17">  <span class="va">lightship</span>.<span class="at">signalReady</span>()</a>
<a class="sourceLine" id="cb4-18" title="18"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb4-19" title="19"></a>
<a class="sourceLine" id="cb4-20" title="20"><span class="co">// You can signal that the service is not ready using `lightship.signalNotReady()`.</span></a></code></pre>
    </div>
    <p>
      <a href="https://github.com/gajus/lightship">Lightship 문서</a>에서
      <a
        href="https://github.com/gajus/lightship#lightship-usage-kubernetes-container-probe-configuration"
        >Kubernetes 설정</a
      >에 대한 예시와
      <a href="https://github.com/gajus/lightship#using-with-expressjs"
        >Express.js</a
      >와의 통합 절차에 대한 완전한 예시를 제공합니다.
    </p>
  </body>
</html>
