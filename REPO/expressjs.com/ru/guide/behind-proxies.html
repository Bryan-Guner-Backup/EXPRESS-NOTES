<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru" xml:lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>Express за прокси</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
  </head>
  <body>
    <header id="title-block-header">
      <h1 class="title">Express за прокси</h1>
    </header>
    <h1 id="express-за-прокси">Express за прокси</h1>
    <p>
      При запуске приложения Express за прокси-сервером, необходимо указать (с
      помощью
      <a href="/%7B%7B%20page.lang%20%7D%7D/4x/api.html#app.set">app.set()</a>)
      для переменной приложения <code>trust proxy</code> одно из значений,
      приведенных в таблице ниже.
    </p>
    <div class="doc-box doc-info" data-markdown="1">
      <p>
        Хотя приложение будет запущено и без указания значения переменной
        приложения <code>trust proxy</code>, отсутствие заданного значения
        <code>trust proxy</code> приведет к некорректной регистрации IP-адреса
        прокси в качестве клиентского IP-адреса.
      </p>
    </div>
    <table class="doctable" border="1" markdown="1">
      <thead>
        <tr>
          <th>Тип</th>
          <th>Значение</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Булевский</td>
          <td>
            <p>
              Если указано значение <code>true</code>, клиентским IP-адресом
              считается первая слева запись в заголовке
              <code>X-Forwarded-*</code>.
            </p>
            Если указано значение <code>false</code>, приложение считается
            имеющим прямой выход в Интернет, и IP-адрес клиента будет
            производным от <code>req.connection.remoteAddress</code>. Это
            значение используется по умолчанию.
          </td>
        </tr>
        <tr>
          <td>IP-адреса</td>
          <td>
            <p>
              IP-адрес, подсеть или массив IP-адресов и подсетей, считающихся
              надежными. В приведенном ниже списке перечислены предварительно
              заданные имена подсетей:
            </p>
            <ul>
              <li>loopback - <code>127.0.0.1/8</code>, <code>::1/128</code></li>
              <li>
                linklocal - <code>169.254.0.0/16</code>, <code>fe80::/10</code>
              </li>
              <li>
                uniquelocal - <code>10.0.0.0/8</code>,
                <code>172.16.0.0/12</code>, <code>192.168.0.0/16</code>,
                <code>fc00::/7</code>
              </li>
            </ul>
            <p>IP-адреса можно задать любым из указанных ниже способов:</p>
            <pre>
<code class="language-js" translate="no">app.set('trust proxy', 'loopback') // specify a single subnet
app.set('trust proxy', 'loopback, 123.123.123.123') // specify a subnet and an address
app.set('trust proxy', 'loopback, linklocal, uniquelocal') // specify multiple subnets as CSV
app.set('trust proxy', ['loopback', 'linklocal', 'uniquelocal']) // specify multiple subnets as an array</code>
</pre>
            Если IP-адреса или подсети указаны, они исключаются из процесса
            определения адреса, и незащищенный IP-адрес, ближайший к серверу
            приложений, будет определен как IP-адрес клиента.
          </td>
        </tr>
        <tr>
          <td>Число</td>
          <td>
            Считать защищенным <code>n</code>-й элемент пути от прокси-сервера
            со стороны клиента, в качестве клиента.
          </td>
        </tr>
        <tr>
          <td>Функция</td>
          <td>
            Реализация нестандартного механизма защиты. Используйте этот метод,
            только если вы уверены в своих знаниях.
            <pre>
<code class="language-js" translate="no">app.set('trust proxy', function (ip) {
  if (ip === '127.0.0.1' || ip === '123.123.123.123') return true; // trusted IPs
  else return false;
});</code>
</pre>
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      Установка значения, отличного от <code>false</code>, для
      <code>trust proxy</code> ведет к трем существенным изменениям:
    </p>
    <ul>
      <li>
        Значение
        <a href="/%7B%7B%20page.lang%20%7D%7D/api.html#req.hostname"
          >req.hostname</a
        >
        является производным от значения, указанного в заголовке
        <code>X-Forwarded-Host</code>, который может быть задан клиентом или
        прокси.
      </li>
      <li>
        Заголовок <code>X-Forwarded-Proto</code> может быть задан обратным
        прокси-сервером и указывает приложению на использование протокола
        <code>https</code>, или <code>http</code>, или даже недопустимого имени.
        Это значение отражается в
        <a href="/%7B%7B%20page.lang%20%7D%7D/api.html#req.protocol"
          >req.protocol</a
        >.
      </li>
      <li>
        Значения
        <a href="/%7B%7B%20page.lang%20%7D%7D/api.html#req.ip">req.ip</a> и
        <a href="/%7B%7B%20page.lang%20%7D%7D/api.html#req.ips">req.ips</a>
        заполняются собой списком адресов, взятых из
        <code>X-Forwarded-For</code>.
      </li>
    </ul>
    <p>
      Параметр <code>trust proxy</code> реализуется с помощью пакета
      <a href="https://www.npmjs.com/package/proxy-addr">proxy-addr</a>.
      Дополнительная информация приведена в документации к нему.
    </p>
  </body>
</html>
