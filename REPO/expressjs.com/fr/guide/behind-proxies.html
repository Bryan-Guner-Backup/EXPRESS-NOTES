<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <title>Serveurs proxy derrière Express</title>
    <style type="text/css">
      code {
        white-space: pre-wrap;
      }
      span.smallcaps {
        font-variant: small-caps;
      }
      span.underline {
        text-decoration: underline;
      }
      div.column {
        display: inline-block;
        vertical-align: top;
        width: 50%;
      }
    </style>
  </head>
  <body>
    <header id="title-block-header">
      <h1 class="title">Serveurs proxy derrière Express</h1>
    </header>
    <h1 id="express-derrière-proxys">Express derrière proxys</h1>
    <p>
      Lorsque vous exécutez une application Express derrière un proxy, affectez
      à la variable d’application <code>trust proxy</code> l’une des valeurs
      indiquées dans le tableau suivant, en utilisant
      <a href="/%7B%7B%20page.lang%20%7D%7D/4x/api.html#app.set">app.set()</a>.
    </p>
    <div class="doc-box doc-info" data-markdown="1">
      <p>
        L’exécution de l’application n’échouera pas si la variable d’application
        <code>trust proxy</code> n’est pas définie, mais l’adresse IP du proxy
        sera enregistrée de manière incorrecte en tant qu’adresse IP du
        client.``
      </p>
    </div>
    <table class="doctable" border="1" markdown="1">
      <thead>
        <tr>
          <th>Type</th>
          <th>Valeur</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Booléen</td>
          <td>
            Si la valeur est <code>true</code>, l’adresse IP du client est
            interprétée comme étant l’entrée la plus à gauche dans l’en-tête
            <code>X-Forwarded-*</code>. Si la valeur est <code>false</code>,
            l’application est interprétée comme étant directement accessible sur
            Internet et l’adresse IP du client est dérivée de
            <code>req.connection.remoteAddress</code>. Il s’agit du paramètre
            par défaut.
          </td>
        </tr>
        <tr>
          <td>Adresses IP</td>
          <td>
            <p>
              Adresse IP, sous-réseau ou tableau d’adresses IP et de
              sous-réseaux auxquels faire confiance. La liste suivante montre
              les noms de sous-réseau préconfigurés : * loopback -
              <code>127.0.0.1/8</code>, <code>::1/128</code> * linklocal -
              <code>169.254.0.0/16</code>, <code>fe80::/10</code> * uniquelocal
              - <code>10.0.0.0/8</code>, <code>172.16.0.0/12</code>,
              <code>192.168.0.0/16</code>, <code>fc00::/7</code>
            </p>
            <p>
              Vous pouvez définir les adresses IP de l’une des manières
              suivantes :
            </p>
            <pre>
<code class="language-js" translate="no">app.set('trust proxy', 'loopback') // specify a single subnet
app.set('trust proxy', 'loopback, 123.123.123.123') // specify a subnet and an address
app.set('trust proxy', 'loopback, linklocal, uniquelocal') // specify multiple subnets as CSV
app.set('trust proxy', ['loopback', 'linklocal', 'uniquelocal']) // specify multiple subnets as an array</code>
</pre>
            S’ils sont spécifiés, les sous-réseaux ou les adresses IP sont
            exclus du processus d’identification d’adresse, et l’adresse IP sans
            confiance la plus proche du serveur d’applications est identifiée
            comme étant l’adresse IP du client.
          </td>
        </tr>
        <tr>
          <td>Numérique</td>
          <td>
            Approuve le <code>n</code>ème tronçon à partir proxy de face comme
            étant le client.
          </td>
        </tr>
        <tr>
          <td>Fonction</td>
          <td>
            Implémentation de confiance personnalisée. N’utilisez cette option
            que si vous êtes sûr de vous.
            <pre>
<code class="language-js" translate="no">app.set('trust proxy', function (ip) {
  if (ip === '127.0.0.1' || ip === '123.123.123.123') return true; // trusted IPs
  else return false;
});</code>
</pre>
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      La définition d’une valeur autre que <code>false</code>
      <code>trust proxy</code> entraîne trois modifications importantes :
    </p>
    <ul>
      <li>
        La valeur de
        <a href="/%7B%7B%20page.lang%20%7D%7D/api.html#req.hostname"
          >req.hostname</a
        >
        est dérivée de l’ensemble de valeurs indiqué dans l’en-tête
        <code>X-Forwarded-Host</code>, qui peut être défini par le client ou par
        le proxy.
      </li>
      <li>
        <code>X-Forwarded-Proto</code> peut être défini par le proxy inverse
        pour indiquer à l’application s’il s’agit de <code>https</code> ou de
        <code>http</code>, voire d’un nom non valide. Cette valeur est reflétée
        par
        <a href="/%7B%7B%20page.lang%20%7D%7D/api.html#req.protocol"
          >req.protocol</a
        >.
      </li>
      <li>
        Les valeurs
        <a href="/%7B%7B%20page.lang%20%7D%7D/api.html#req.ip">req.ip</a> et
        <a href="/%7B%7B%20page.lang%20%7D%7D/api.html#req.ips">req.ips</a> sont
        renseignées avec la liste des adresses provenant de
        <code>X-Forwarded-For</code>.
      </li>
    </ul>
    <p>
      Le paramètre <code>trust proxy</code> est implémenté à l’aide du package
      <a href="https://www.npmjs.com/package/proxy-addr">proxy-addr</a>. Pour
      plus d’informations, consultez la documentation associée.
    </p>
  </body>
</html>
