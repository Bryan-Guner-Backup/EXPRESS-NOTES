<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="th" xml:lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Process managers for Express apps</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Process managers for Express apps</h1>
</header>
<h1 id="process-managers-for-express-apps">Process managers for Express apps</h1>
<p>When you run Express apps for production, it is helpful to use a <em>process manager</em> to achieve the following tasks:</p>
<ul>
<li>Restart the app automatically if it crashes.</li>
<li>Gain insights into runtime performance and resource consumption.</li>
<li>Modify settings dynamically to improve performance.</li>
<li>Control clustering.</li>
</ul>
<p>A process manager is somewhat like an application server: it’s a “container” for applications that facilitates deployment, provides high availability, and enables you to manage the application at runtime.</p>
<p>The most popular process managers for Express and other Node.js applications are as follows:</p>
<ul>
<li><a href="#strongloop-process-manager">StrongLoop Process Manager</a></li>
<li><a href="#pm2">PM2</a></li>
<li><a href="#forever">Forever</a></li>
<li><a href="#systemd">SystemD</a></li>
</ul>
<p>Using any of these four tools can be very helpful, however StrongLoop Process Manager is the only tool that provides a comprehensive runtime and deployment solution that addresses the entire Node.js application life cycle, with tooling for every step before and after production, in a unified interface.</p>
<p>Here’s a brief look at each of these tools. For a detailed comparison, see <a href="http://strong-pm.io/compare/">http://strong-pm.io/compare/</a>.</p>
<h2 id="strongloop-process-manager">StrongLoop Process Manager</h2>
<p>StrongLoop Process Manager (StrongLoop PM) is a production process manager for Node.js applications. StrongLoop PM has built-in load balancing, monitoring, and multi-host deployment, and a graphical console. You can use StrongLoop PM for the following tasks:</p>
<ul>
<li>Build, package, and deploy your Node.js application to a local or remote system.</li>
<li>View CPU profiles and heap snapshots to optimize performance and diagnose memory leaks.</li>
<li>Keep processes and clusters alive forever.</li>
<li>View performance metrics on your application.</li>
<li>Easily manage multi-host deployments with Nginx integration.</li>
<li>Unify multiple StrongLoop PMs to a distributed microservices runtime that is managed from Arc.</li>
</ul>
<p>You can work with StrongLoop PM by using a powerful command-line interface tool called <code>slc</code>, or a graphical tool called Arc. Arc is open source, with professional support provided by StrongLoop.</p>
<p>For more information, see <a href="http://strong-pm.io/">http://strong-pm.io/</a>.</p>
<p>Full documentation:</p>
<ul>
<li><a href="http://docs.strongloop.com/display/SLC">Operating Node apps (StrongLoop documentation)</a></li>
<li><a href="http://docs.strongloop.com/display/SLC/Using+Process+Manager">Using StrongLoop Process Manager</a>.</li>
</ul>
<h3 id="installation">Installation</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1">$ [<span class="ex">sudo</span>] npm install -g strongloop</a></code></pre></div>
<h3 id="basic-use">Basic use</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1">$ <span class="bu">cd</span> my-app</a>
<a class="sourceLine" id="cb2-2" title="2">$ <span class="ex">slc</span> start</a></code></pre></div>
<p>View the status of Process Manager and all deployed apps:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1">$ <span class="ex">slc</span> ctl</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="ex">Service</span> ID: 1</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="ex">Service</span> Name: my-app</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="ex">Environment</span> variables:</a>
<a class="sourceLine" id="cb3-5" title="5">  <span class="ex">No</span> environment variables defined</a>
<a class="sourceLine" id="cb3-6" title="6"><span class="ex">Instances</span>:</a>
<a class="sourceLine" id="cb3-7" title="7">    <span class="ex">Version</span>  Agent version  Cluster size</a>
<a class="sourceLine" id="cb3-8" title="8">     <span class="ex">4.1.13</span>      1.5.14           4</a>
<a class="sourceLine" id="cb3-9" title="9"><span class="ex">Processes</span>:</a>
<a class="sourceLine" id="cb3-10" title="10">        <span class="ex">ID</span>      PID   WID  Listening Ports  Tracking objects?  CPU profiling?</a>
<a class="sourceLine" id="cb3-11" title="11">    <span class="ex">1.1.57692</span>  57692   0</a>
<a class="sourceLine" id="cb3-12" title="12">    <span class="ex">1.1.57693</span>  57693   1     0.0.0.0:3001</a>
<a class="sourceLine" id="cb3-13" title="13">    <span class="ex">1.1.57694</span>  57694   2     0.0.0.0:3001</a>
<a class="sourceLine" id="cb3-14" title="14">    <span class="ex">1.1.57695</span>  57695   3     0.0.0.0:3001</a>
<a class="sourceLine" id="cb3-15" title="15">    <span class="ex">1.1.57696</span>  57696   4     0.0.0.0:3001</a></code></pre></div>
<p>List all the apps (services) under management:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1">$ <span class="ex">slc</span> ctl ls</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="ex">Id</span>          Name         Scale</a>
<a class="sourceLine" id="cb4-3" title="3"> <span class="ex">1</span>          my-app       1</a></code></pre></div>
<p>Stop an app:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1">$ <span class="ex">slc</span> ctl stop my-app</a></code></pre></div>
<p>Restart an app:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1">$ <span class="ex">slc</span> ctl restart my-app</a></code></pre></div>
<p>You can also “soft restart,” which gives worker processes a grace period to close existing connections, then restarts the current application:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1">$ <span class="ex">slc</span> ctl soft-restart my-app</a></code></pre></div>
<p>To remove an app from management:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1">$ <span class="ex">slc</span> ctl remove my-app</a></code></pre></div>
<h2 id="pm2">PM2</h2>
<p>PM2 is a production process manager for Node.js applications, that has a built-in load balancer. PM2 allows you to keep applications alive forever and reload them without downtime, and will facilitate common system admin tasks. PM2 also enables you to manage application logging, monitoring, and clustering.</p>
<p>For more information, see <a href="https://github.com/Unitech/pm2">https://github.com/Unitech/pm2</a>.</p>
<h3 id="installation-1">Installation</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1">$ [<span class="ex">sudo</span>] npm install pm2 -g</a></code></pre></div>
<h3 id="basic-use-1">Basic use</h3>
<p>When you start an app by using the <code>pm2</code> command, you must specify the path of the app. However, when you stop, restart, or delete an app, you can specify just the name or the id of the app.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" title="1">$ <span class="ex">pm2</span> start npm --name my-app -- start</a>
<a class="sourceLine" id="cb10-2" title="2">[<span class="ex">PM2</span>] restartProcessId process id 0</a>
<a class="sourceLine" id="cb10-3" title="3">┌──────────┬────┬──────┬───────┬────────┬─────────┬────────┬─────────────┬──────────┐</a>
<a class="sourceLine" id="cb10-4" title="4">│ <span class="ex">App</span> name │ id │ mode │ pid   │ status │ restart │ uptime │ memory      │ watching │</a>
<a class="sourceLine" id="cb10-5" title="5">├──────────┼────┼──────┼───────┼────────┼─────────┼────────┼─────────────┼──────────┤</a>
<a class="sourceLine" id="cb10-6" title="6">│ <span class="ex">my-app</span>   │ 0  │ fork │ 64029 │ online │ 1       │ 0s     │ 17.816 MB   │ disabled │</a>
<a class="sourceLine" id="cb10-7" title="7">└──────────┴────┴──────┴───────┴────────┴─────────┴────────┴─────────────┴──────────┘</a>
<a class="sourceLine" id="cb10-8" title="8"> <span class="ex">Use</span> the <span class="kw">`</span><span class="ex">pm2</span> show <span class="op">&lt;</span>id<span class="kw">|</span><span class="ex">name</span><span class="op">&gt;</span><span class="kw">`</span> command to get more details about an app.</a></code></pre></div>
<p>When you start an app by using the <code>pm2</code> command, the app is immediately sent to the background. You can control the background app from the command line by using various <code>pm2</code> commands.</p>
<p>After an app is started by using the <code>pm2</code> command, it is registered in PM2’s list of processes with an ID. You can therefore manage apps with the same name from different directories on the system, by using their IDs.</p>
<p>Note that if more than one app with the same name is running, <code>pm2</code> commands affect all of them. So use IDs instead of names to manage individual apps.</p>
<p>List all running processes:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" title="1">$ <span class="ex">pm2</span> list</a></code></pre></div>
<p>Stop an app:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" title="1">$ <span class="ex">pm2</span> stop 0</a></code></pre></div>
<p>Restart an app:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" title="1">$ <span class="ex">pm2</span> restart 0</a></code></pre></div>
<p>To view detailed information about an app:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" title="1">$ <span class="ex">pm2</span> show 0</a></code></pre></div>
<p>To remove an app from PM2’s registry:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" title="1">$ <span class="ex">pm2</span> delete 0</a></code></pre></div>
<h2 id="forever">Forever</h2>
<p>Forever is a simple command-line interface tool for ensuring that a given script runs continuously (forever). Forever’s simple interface makes it ideal for running smaller deployments of Node.js apps and scripts.</p>
<p>For more information, see <a href="https://github.com/foreverjs/forever">https://github.com/foreverjs/forever</a>.</p>
<h3 id="installation-2">Installation</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb16-1" title="1">$ [<span class="ex">sudo</span>] npm install forever -g</a></code></pre></div>
<h3 id="basic-use-2">Basic use</h3>
<p>To start a script, use the <code>forever start</code> command and specify the path of the script:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb17-1" title="1">$ <span class="ex">forever</span> start script.js</a></code></pre></div>
<p>This command will run the script in daemon mode (in the background).</p>
<p>To run the script so that it is attached to the terminal, omit <code>start</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb18-1" title="1">$ <span class="ex">forever</span> script.js</a></code></pre></div>
<p>It is a good idea to log output from the Forever tool and the script by using the logging options <code>-l</code>, <code>-o</code>, and <code>-e</code>, as shown this example:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb19-1" title="1">$ <span class="ex">forever</span> start -l forever.log -o out.log -e err.log script.js</a></code></pre></div>
<p>To view the list of scripts that were started by Forever:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb20-1" title="1">$ <span class="ex">forever</span> list</a></code></pre></div>
<p>To stop a script that was started by Forever use the <code>forever stop</code> command and specify the process index (as listed by the <code>forever list</code> command).</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb21-1" title="1">$ <span class="ex">forever</span> stop 1</a></code></pre></div>
<p>Alternatively, specify the path of the file:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb22-1" title="1">$ <span class="ex">forever</span> stop script.js</a></code></pre></div>
<p>To stop all the scripts that were started by Forever:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb23-1" title="1">$ <span class="ex">forever</span> stopall</a></code></pre></div>
<p>Forever has many more options, and it also provides a programmatic API.</p>
<h2 id="systemd">SystemD</h2>
<h3 id="introduction">Introduction</h3>
<p>SystemD is the default process manager on modern Linux distributions. Running a Node service based on SystemD is very simple. NOTE: This section is based on <span class="citation" data-cites="axllent">[a blog post by Ralph Slooten (@axllent)]</span>(https://www.axllent.org/docs/view/nodejs-service-with-systemd/).</p>
<h3 id="set-up-the-service">Set up the service</h3>
<p>Create a file in <code>/etc/systemd/system/express.service</code>:</p>
<pre><code>[Unit]
Description=Express
# Set dependencies to other services (optional)
#After=mongodb.service

[Service]
# Run Grunt before starting the server (optional)
#ExecStartPre=/usr/bin/grunt

# Start the js-file starting the express server
ExecStart=/usr/bin/node server.js
WorkingDirectory=/usr/local/express
Restart=always
RestartSec=10
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=Express
# Change to a non-root user (optional, but recommended)
#User=&lt;alternate user&gt;
#Group=&lt;alternate group&gt;
# Set environment options
Environment=NODE_ENV=production PORT=8080

[Install]
WantedBy=multi-user.target</code></pre>
<h3 id="enable-service">Enable service</h3>
<pre><code>$ systemctl enable express.service</code></pre>
<h3 id="start-service">Start service</h3>
<pre><code>$ systemctl start express.service</code></pre>
<h3 id="check-service-status">Check service status</h3>
<pre><code>$ systemctl status express.service</code></pre>
</body>
</html>
