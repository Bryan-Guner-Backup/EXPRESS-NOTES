<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="tr" xml:lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Express hata işleme</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Express hata işleme</h1>
</header>
<h1 id="hata-işleme">Hata İşleme</h1>
<p><em>Error Handling</em>, senkron ve asenkron olarak meydana gelen hataların Express tarafından nasıl yakalandığına ve işlendiğine değinir. Express varsayılan olarak bir hata işleyiciyle gelir, bu nedenle hata işlemeye başlamak için kendinizin yazmanıza gerek yoktur.</p>
<h2 id="hataları-yakalamak">Hataları Yakalamak</h2>
<p>Express tarafından, rota işleyicileri ve ara yazılımları koşarken oluşan hataların yakalanmasının sağlanması önemlidir. Rota işleyicilerinde ve ara yazılımlarda senkron kodda oluşan hataları yakalamak için ek birşey yapmaka gerek yoktur. Eğer senkron kod bir hata fırlatırsa, Express onu yakalayıp işleyecektir. Örneğin:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="kw">function</span> (req<span class="op">,</span> res) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-2" title="2">  <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;BROKEN&#39;</span>) <span class="co">// Express bunu kendi kendine yakalayacak</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="op">}</span>)</a></code></pre></div>
<p>Rota işleyicileri ve ara yazılım tarafından çağrılan asenkron fonksiyonlardan dönen hataları Express’in yakalayp işleyeceği <code>next()</code> fonksiyonuna vermelisiniz. Örnek olarak:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="kw">function</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">&#39;/file-does-not-exist&#39;</span><span class="op">,</span> <span class="kw">function</span> (err<span class="op">,</span> data) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-3" title="3">    <span class="cf">if</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-4" title="4">      <span class="at">next</span>(err) <span class="co">// Hataları Express&#39;e ver</span></a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-6" title="6">      <span class="va">res</span>.<span class="at">send</span>(data)</a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb2-8" title="8">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb2-9" title="9"><span class="op">}</span>)</a></code></pre></div>
<p>Express 5 ile başlayarak, Promise döndüren rota işleyicileri ve ara yazılımlar ret verdiklerinde (reject) veya hata fırlattıklarında otomatik olarak <code>next(value)</code> fonksiyonunu çağıracaklar. Örneğin:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/user/:id&#39;</span><span class="op">,</span> <span class="kw">async</span> <span class="kw">function</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="kw">var</span> user <span class="op">=</span> <span class="cf">await</span> <span class="at">getUserById</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span>)</a>
<a class="sourceLine" id="cb3-3" title="3">  <span class="va">res</span>.<span class="at">send</span>(user)</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="op">}</span>)</a></code></pre></div>
<p><code>getUserById</code> bir hata fırlattığında veya ret verdiğinde, <code>next</code> fonksiyonu ya fırlatılan hatayla ya da ret verilen değer ile çağrılacaktır. Eğer herhangi bir ret değeri verilmediyse, <code>next</code> fonksiyonu Express yönlendiricisi tarafından sağlanan varsayılan Error objesiyle çağrılacak.</p>
<p>Eğer <code>next()</code> fonksiyonuna herhangi birşey verdiğinizde (<code>'route'</code> karakter dizisi hariç), Express şimdiki isteği bir hata olarak sayıp hata işlemeyen yönlendirici ve ara yazılım fonksiyonlarını es geçecektir.</p>
<p>Eğer bir dizideki geri çağırma fonksiyonu veri sağlamıyorsa, sadece hataları veriyorsa, kodu bu şekilde basitleştirebilirsiniz:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> [</a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="kw">function</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="va">fs</span>.<span class="at">writeFile</span>(<span class="st">&#39;/erişilemez-yol&#39;</span><span class="op">,</span> <span class="st">&#39;data&#39;</span><span class="op">,</span> next)</a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="op">},</span></a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="kw">function</span> (req<span class="op">,</span> res) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-6" title="6">    <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;OK&#39;</span>)</a>
<a class="sourceLine" id="cb4-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb4-8" title="8">])</a></code></pre></div>
<p>Yukarıdaki örnekte <code>next</code>, hata veya hatasız olarak çağrılan <code>fs.writeFile</code> için geri çağırma fonksiyonu olarak verlidi. Eğer hata yok ise ikinci işleyici çalışacak, aksi takdirde Express hatayı yakalayıp işler.</p>
<p>Rota işleyicileri ve ara yazılımlar tarafından çağrılan asenkron kodda oluşan hataları yakalayıp işlemesi için Express’e geçmelisiniz. Örnek olarak:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="kw">function</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-2" title="2">  <span class="at">setTimeout</span>(<span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-4" title="4">      <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;BROKEN&#39;</span>)</a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-6" title="6">      <span class="at">next</span>(err)</a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="op">}</span></a>
<a class="sourceLine" id="cb5-8" title="8">  <span class="op">},</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb5-9" title="9"><span class="op">}</span>)</a></code></pre></div>
<p>Yukarıdaki örnek asenkron kodda hataları yakalamak için bir <code>try...catch</code> bloku kullanıyor. Eğer <code>try...catch</code> bloku olmaz ise, işleyici senkron kodun bir parçası olmadığı için Express hatayı yakalamayacak.</p>
<p><code>try..catch</code> blokunun yükünden kaçınmak için promise veya promise döndüren fonksiyonlar kullanın. Örnek olarak:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> <span class="kw">function</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="va">Promise</span>.<span class="at">resolve</span>().<span class="at">then</span>(<span class="kw">function</span> () <span class="op">{</span></a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="cf">throw</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&#39;BROKEN&#39;</span>)</a>
<a class="sourceLine" id="cb6-4" title="4">  <span class="op">}</span>).<span class="at">catch</span>(next) <span class="co">// Hatalar Express&#39;e geçer</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="op">}</span>)</a></code></pre></div>
<p>Promise’lar otomatik olarak senkron hatalarını ve ret edilen promise’ları yakaladığından, sonuncu yakalama işleyicisi olarak <code>next</code> fonksiyonunu verebilirsiniz ve Express hataları yakalar, çünkü yakalama işleyicisine birinci argüman olarak hata verimiştir.</p>
<p>Senkron hata yakalamaya güvenmek için asenkron kodu basite indirgeyerek bir işleyiciler zincirini de kullanabilirsiniz. Örnek olarak:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> [</a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="kw">function</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-3" title="3">    <span class="va">fs</span>.<span class="at">readFile</span>(<span class="st">&#39;/maybe-valid-file&#39;</span><span class="op">,</span> <span class="st">&#39;utf-8&#39;</span><span class="op">,</span> <span class="kw">function</span> (err<span class="op">,</span> data) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-4" title="4">      <span class="va">res</span>.<span class="va">locals</span>.<span class="at">data</span> <span class="op">=</span> data</a>
<a class="sourceLine" id="cb7-5" title="5">      <span class="at">next</span>(err)</a>
<a class="sourceLine" id="cb7-6" title="6">    <span class="op">}</span>)</a>
<a class="sourceLine" id="cb7-7" title="7">  <span class="op">},</span></a>
<a class="sourceLine" id="cb7-8" title="8">  <span class="kw">function</span> (req<span class="op">,</span> res) <span class="op">{</span></a>
<a class="sourceLine" id="cb7-9" title="9">    <span class="va">res</span>.<span class="va">locals</span>.<span class="at">data</span> <span class="op">=</span> <span class="va">res</span>.<span class="va">locals</span>.<span class="va">data</span>.<span class="at">split</span>(<span class="st">&#39;,&#39;</span>)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb7-10" title="10">    <span class="va">res</span>.<span class="at">send</span>(<span class="va">res</span>.<span class="va">locals</span>.<span class="at">data</span>)</a>
<a class="sourceLine" id="cb7-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb7-12" title="12">])</a></code></pre></div>
<p>Yukarıdaki örnek <code>readFile</code> çağrısından birkaç basit ifadeye sahip. <code>readFile</code> bir hata alırsa, bu hatayı Express’e verir, aksi takdirde hızlı bir şekilde zincirdeki bir sonraki işleyicide asenkron hata işleme dünyasına dönersiniz. Ve, yukarıdaki örnek veriyi işlemeyi gösterir. Bu işlem hata verirse, onu senkron hata işleyicisi yakalayacak. Eğer bu işlemleri <code>readFile</code> geri çağırma fonksiyonunun içinde yaptıysanız uygulama kapanabilir ve Express hata işleyicileri çalışmaz.</p>
<p>Hangi yöntemi kullanırsanız kullanın, Express hata işleyicilerinin çağrılmasını ve uygulamanın hayatta kalmasını istiyorsanız, Express’in hatayı aldığından emin olmalısınız.</p>
<h2 id="varsayılan-hata-işleyicisi">Varsayılan hata işleyicisi</h2>
<p>Express, uygulamada oluşabilecek herhangi bir hatayla ilgilenecek gömülü bir hata işleyicisiyle gelir. Bu varsayıla hata işleyici ara yazılım fonksiyonu, ara yazlım fonksiyon yığınının en sonuna eklenir.</p>
<p><code>next()</code> fonksiyonuna bir hata verip özel bir hata işleyicisinde işlemezseniz, bu hata gömülü hata işleyicisi tarafından işlenir; hata istemcide stack-trace ile beraber yazdırılır. Stack-trace üretim (production) ortamında dahil değildir.</p>
<div class="doc-box doc-info" data-markdown="1">
<p>Uygulamayı üretim modunda koşmak için <code>NODE_ENV</code> ortam değişkeninin değerini <code>production</code> olarak ayarlayın.</p>
</div>
<p>Bir hata yazdırıldığında, aşağıdaki bilgiler yanıta eklenir:</p>
<ul>
<li><code>res.statusCode</code> alanının değeri <code>err.status</code> alanından gelir (veya <code>err.statusCode</code>). Eğer bu değer 4xx veya 5xx’in aralığında değilse, 500 olarak ayarlanacak.</li>
<li><code>res.statusMessage</code> alanı statü koduna göre ayarlanır.</li>
<li>Üretim modunda ise, gövde (body) statü kodu mesajının HTML’i olur, aksi takdirde ise <code>err.stack</code>.</li>
<li><code>err.headers</code> objesinde belirtilen herhangi bir başlık (header).</li>
</ul>
<p><code>next()</code> fonksiyonunu yanıtı yazmaya başladıktan sonra bir hata ile çağırırsanız (örneğin, istemciye yanıtı aktarma esnasında bir hata ile karşılaşırsanız) varsayılan Express hata işleyicisi bağlantıyı kapatıp isteği başarısız kılar.</p>
<p>Özel bir hata işleyicisi eklediğiniz zaman başlıklar (header) halihazırda istemciye gönderilmiş ise varsayılan Express hata işleyicisine yetki vermelisiniz:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">function</span> <span class="at">errorHandler</span> (err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-2" title="2">  <span class="cf">if</span> (<span class="va">res</span>.<span class="at">headersSent</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-3" title="3">    <span class="cf">return</span> <span class="at">next</span>(err)</a>
<a class="sourceLine" id="cb8-4" title="4">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-5" title="5">  <span class="va">res</span>.<span class="at">status</span>(<span class="dv">500</span>)</a>
<a class="sourceLine" id="cb8-6" title="6">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">error</span><span class="op">:</span> err <span class="op">}</span>)</a>
<a class="sourceLine" id="cb8-7" title="7"><span class="op">}</span></a></code></pre></div>
<p>Kodunuzda <code>next()</code> fonksiyonunu bir hata ile birden fazla kez çağırdığınızda varsayılan hata işleyicisi tetiklenebilir, özel hata işleyici ara yazılımı yerinde olsa bile.</p>
<h2 id="hata-işleyicileri-yazmak">Hata işleyicileri yazmak</h2>
<p>Hata işleyici ara yazılım fonksiyonlarını diğer ara yazılım fonksiyonları gibi tanımlayınız, bundan farklı olarak hata işleyici fonksiyonlar üç yerine dört argümana sahipler: <code>(err, req, res, next)</code>. Örneğin:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="va">app</span>.<span class="at">use</span>(<span class="kw">function</span> (err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-2" title="2">  <span class="va">console</span>.<span class="at">error</span>(<span class="va">err</span>.<span class="at">stack</span>)</a>
<a class="sourceLine" id="cb9-3" title="3">  <span class="va">res</span>.<span class="at">status</span>(<span class="dv">500</span>).<span class="at">send</span>(<span class="st">&#39;Birşeyler bozuldu&#39;</span>)</a>
<a class="sourceLine" id="cb9-4" title="4"><span class="op">}</span>)</a></code></pre></div>
<p>Hata işleyici ara yazılımları diğer <code>app.use()</code> ve rotaların çağrılarından sonra, en son tanımlanır; örnek olarak:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">var</span> bodyParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;body-parser&#39;</span>)</a>
<a class="sourceLine" id="cb10-2" title="2"><span class="kw">var</span> methodOverride <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;method-override&#39;</span>)</a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="va">app</span>.<span class="at">use</span>(<span class="va">bodyParser</span>.<span class="at">urlencoded</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb10-5" title="5">  <span class="dt">extended</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb10-6" title="6"><span class="op">}</span>))</a>
<a class="sourceLine" id="cb10-7" title="7"><span class="va">app</span>.<span class="at">use</span>(<span class="va">bodyParser</span>.<span class="at">json</span>())</a>
<a class="sourceLine" id="cb10-8" title="8"><span class="va">app</span>.<span class="at">use</span>(<span class="at">methodOverride</span>())</a>
<a class="sourceLine" id="cb10-9" title="9"><span class="va">app</span>.<span class="at">use</span>(<span class="kw">function</span> (err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb10-10" title="10">  <span class="co">// iş mantığı</span></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="op">}</span>)</a></code></pre></div>
<p>Ara yazılımdaki yanıtlar HTML hata sayfası, basit bir mesaj veya bir JSON karakter dizisi gibi herhangi bir biçimde olabilir.</p>
<p>Organizasyonel (ve daha üst-düzey çatı) amaçlar için, normal ara yazılım fonksiyonları gibi, birden fazla hata-işleyici ara yazılım fonksiyonu tanımlayabilirsiniz. Örnek olarak, <code>XHR</code> kullanılan ve <code>XHR</code> kullanılmayan istekler için bir hata işleyici tanımlamak gibi:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">var</span> bodyParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;body-parser&#39;</span>)</a>
<a class="sourceLine" id="cb11-2" title="2"><span class="kw">var</span> methodOverride <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;method-override&#39;</span>)</a>
<a class="sourceLine" id="cb11-3" title="3"></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="va">app</span>.<span class="at">use</span>(<span class="va">bodyParser</span>.<span class="at">urlencoded</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb11-5" title="5">  <span class="dt">extended</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="op">}</span>))</a>
<a class="sourceLine" id="cb11-7" title="7"><span class="va">app</span>.<span class="at">use</span>(<span class="va">bodyParser</span>.<span class="at">json</span>())</a>
<a class="sourceLine" id="cb11-8" title="8"><span class="va">app</span>.<span class="at">use</span>(<span class="at">methodOverride</span>())</a>
<a class="sourceLine" id="cb11-9" title="9"><span class="va">app</span>.<span class="at">use</span>(logErrors)</a>
<a class="sourceLine" id="cb11-10" title="10"><span class="va">app</span>.<span class="at">use</span>(clientErrorHandler)</a>
<a class="sourceLine" id="cb11-11" title="11"><span class="va">app</span>.<span class="at">use</span>(errorHandler)</a></code></pre></div>
<p>Bu örnekte, jenerik <code>logErrors</code>, <code>stderr</code>’a istek ve hata bilgileri yazabilir, örneğin:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">function</span> <span class="at">logErrors</span> (err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="va">console</span>.<span class="at">error</span>(<span class="va">err</span>.<span class="at">stack</span>)</a>
<a class="sourceLine" id="cb12-3" title="3">  <span class="at">next</span>(err)</a>
<a class="sourceLine" id="cb12-4" title="4"><span class="op">}</span></a></code></pre></div>
<p>Ayrıca bu örnekte, <code>clientErrorHandler</code>aşağıdaki gibi tanımlanır; bu durumda, hata açıkça bir sonrakine aktarılır.</p>
<p>Bir hata işleme fonksiyonunda “next” <em>çağrılmadığında</em>, yanıtın yazılmasından (ve sonlandırılmasından) siz sorumlusunuz. Aksi takdirde o istekler “havada” kalır ve çöp toplama (garbage collection) için geçerli olmayacaktır.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">function</span> <span class="at">clientErrorHandler</span> (err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="cf">if</span> (<span class="va">req</span>.<span class="at">xhr</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb13-3" title="3">    <span class="va">res</span>.<span class="at">status</span>(<span class="dv">500</span>).<span class="at">send</span>(<span class="op">{</span> <span class="dt">error</span><span class="op">:</span> <span class="st">&#39;Birşeyler ters gitti&#39;</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb13-4" title="4">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-5" title="5">    <span class="at">next</span>(err)</a>
<a class="sourceLine" id="cb13-6" title="6">  <span class="op">}</span></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="op">}</span></a></code></pre></div>
<p>“Hepsini-yakala” <code>errorHandler</code> fonksiyonunu aşağıdaki gibi tanımlayın:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">function</span> <span class="at">errorHandler</span> (err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="va">res</span>.<span class="at">status</span>(<span class="dv">500</span>)</a>
<a class="sourceLine" id="cb14-3" title="3">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">error</span><span class="op">:</span> err <span class="op">}</span>)</a>
<a class="sourceLine" id="cb14-4" title="4"><span class="op">}</span></a></code></pre></div>
<p>Birden fazla geri çağırma fonksiyonu olan bir rota işleyiciniz var ise bir sonraki rota işleyicisine geçmek için <code>route</code> parametresini kullanabilirsiniz. Örnek:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb15-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/a_route_behind_paywall&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb15-2" title="2">  <span class="kw">function</span> <span class="at">checkIfPaidSubscriber</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-3" title="3">    <span class="cf">if</span> (<span class="op">!</span><span class="va">req</span>.<span class="va">user</span>.<span class="at">hasPaid</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-4" title="4">      <span class="co">// bu isteği işlemeye devam et</span></a>
<a class="sourceLine" id="cb15-5" title="5">      <span class="at">next</span>(<span class="st">&#39;route&#39;</span>)</a>
<a class="sourceLine" id="cb15-6" title="6">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb15-7" title="7">      <span class="at">next</span>()</a>
<a class="sourceLine" id="cb15-8" title="8">    <span class="op">}</span></a>
<a class="sourceLine" id="cb15-9" title="9">  <span class="op">},</span> <span class="kw">function</span> <span class="at">getPaidContent</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-10" title="10">    <span class="va">PaidContent</span>.<span class="at">find</span>(<span class="kw">function</span> (err<span class="op">,</span> doc) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-11" title="11">      <span class="cf">if</span> (err) <span class="cf">return</span> <span class="at">next</span>(err)</a>
<a class="sourceLine" id="cb15-12" title="12">      <span class="va">res</span>.<span class="at">json</span>(doc)</a>
<a class="sourceLine" id="cb15-13" title="13">    <span class="op">}</span>)</a>
<a class="sourceLine" id="cb15-14" title="14">  <span class="op">}</span>)</a></code></pre></div>
<p>Bu örnekte, <code>getPaidContent</code> işleyicisi es geçilecek ama <code>app</code> uygulaması <code>/a_route_behind_paywall</code> yolu için geriye kalan herhangi bir işleyici çalışmaya devam edecek.</p>
<div class="doc-box doc-info" data-markdown="1">
<p><code>next()</code> ve <code>next(err)</code> fonksiyonlarına yapılacak çağrılar şimdiki işleyicinin tamamlandığını ve hangi durumda tamamlandıklarını belirtir. <code>next(err)</code> çağrısı, yukarıda gösterildiği gibi hata işlemek için kurulanlar hariç, zincirde geriye kalan bütün işleyicileri es geçer.</p>
</div>
</body>
</html>
